services:
    mariadb:
      image: mariadb:11.4
      expose:
        - "3306"
      environment:
        MYSQL_ROOT_PASSWORD: ""
        MYSQL_ALLOW_EMPTY_PASSWORD: yes
      healthcheck:
        test: [ "CMD", "/usr/local/bin/healthcheck.sh", "--su=root", "--connect", "--innodb_initialized" ]
        retries: 5
      volumes:
        - mariadb_data:/var/lib/mysql

    valkey:
      image: valkey/valkey:8
      expose:
        - "6379"
      healthcheck:
        test: [ "CMD", "valkey-cli", "--raw", "incr", "ping" ]
        retries: 5
      volumes:
        - valkey_data:/data

    grimoirelab_core:
      restart: on-failure:3
      image: grimoirelab/grimoirelab:2.x
      environment:
        GRIMOIRELAB_DB_HOST: mariadb
        GRIMOIRELAB_DB_PORT: 3306
        GRIMOIRELAB_DB_DATABASE: core_db
        GRIMOIRELAB_DB_USER: root
        GRIMOIRELAB_DB_PASSWORD: ""
        GRIMOIRELAB_REDIS_HOST: valkey
        GRIMOIRELAB_REDIS_PORT: 6379
        GRIMOIRELAB_REDIS_PASSWORD: ""
        GRIMOIRELAB_SUPERUSER_USERNAME: admin
        GRIMOIRELAB_SUPERUSER_PASSWORD: admin
      expose:
        - "9314"
      volumes:
        - core-static:/core_static/
      depends_on:
        mariadb:
          condition: service_healthy
        valkey:
          condition: service_healthy
      command: grimoirelab run server

    grimoirelab_core_eventizers:
      restart: on-failure:3
      image: grimoirelab/grimoirelab:2.x
      environment:
        GRIMOIRELAB_DB_HOST: mariadb
        GRIMOIRELAB_DB_PORT: 3306
        GRIMOIRELAB_DB_DATABASE: core_db
        GRIMOIRELAB_DB_USER: root
        GRIMOIRELAB_DB_PASSWORD: ""
        GRIMOIRELAB_REDIS_HOST: valkey
        GRIMOIRELAB_REDIS_PORT: 6379
        GRIMOIRELAB_REDIS_PASSWORD: ""
      depends_on:
        mariadb:
          condition: service_healthy
        valkey:
          condition: service_healthy
      command: grimoirelab run eventizers

    grimoirelab_core_archivists:
      restart: on-failure:3
      image: grimoirelab/grimoirelab:2.x
      environment:
        GRIMOIRELAB_DB_HOST: mariadb
        GRIMOIRELAB_DB_PORT: 3306
        GRIMOIRELAB_DB_DATABASE: core_db
        GRIMOIRELAB_DB_USER: root
        GRIMOIRELAB_DB_PASSWORD: ""
        GRIMOIRELAB_REDIS_HOST: valkey
        GRIMOIRELAB_REDIS_PORT: 6379
        GRIMOIRELAB_REDIS_PASSWORD: ""
        GRIMOIRELAB_ARCHIVIST_STORAGE_URL: "https://opensearch-node1:9200"
        GRIMOIRELAB_ARCHIVIST_STORAGE_USERNAME: "admin"
        GRIMOIRELAB_ARCHIVIST_STORAGE_PASSWORD: "GrimoireLab.1"
      depends_on:
        mariadb:
          condition: service_healthy
        valkey:
          condition: service_healthy
        opensearch-node1:
          condition: service_started
      command: grimoirelab run archivists

    grimoirelab_core_ushers:
        restart: on-failure:3
        image: grimoirelab/grimoirelab:2.x
        environment:
          GRIMOIRELAB_DB_HOST: mariadb
          GRIMOIRELAB_DB_PORT: 3306
          GRIMOIRELAB_DB_DATABASE: core_db
          GRIMOIRELAB_DB_USER: root
          GRIMOIRELAB_DB_PASSWORD: ""
          GRIMOIRELAB_REDIS_HOST: valkey
          GRIMOIRELAB_REDIS_PORT: 6379
          GRIMOIRELAB_REDIS_PASSWORD: ""
        depends_on:
          mariadb:
            condition: service_healthy
          valkey:
            condition: service_healthy
        command: grimoirelab run ushers

    sortinghat_worker:
      image: grimoirelab/sortinghat-worker
      environment:
        SORTINGHAT_SECRET_KEY: secret
        SORTINGHAT_DB_HOST: mariadb
        SORTINGHAT_DB_PORT: 3306
        SORTINGHAT_DB_DATABASE: core_db
        SORTINGHAT_DB_USER: root
        SORTINGHAT_DB_PASSWORD: ""
        SORTINGHAT_REDIS_HOST: valkey
        GRIMOIRELAB_REDIS_PORT: 6379
        SORTINGHAT_REDIS_PASSWORD: ""
      depends_on:
        mariadb:
          condition: service_healthy
        valkey:
          condition: service_healthy

    opensearch-node1:
      image: opensearchproject/opensearch:3
      environment:
        cluster.name: opensearch-cluster
        node.name: opensearch-node1
        discovery.type: single-node
        bootstrap.memory_lock: true
        OPENSEARCH_JAVA_OPTS: "-Xms2g -Xmx2g"
        OPENSEARCH_INITIAL_ADMIN_PASSWORD: "GrimoireLab.1"
      ulimits:
        memlock:
          soft: -1
          hard: -1
        nofile:
          soft: 65536
          hard: 65536
      ports:
        - 9200:9200
        - 9600:9600
      volumes:
        - opensearch_data:/usr/share/opensearch/data

    opensearch-dashboards:
      image: opensearchproject/opensearch-dashboards:3
      ports:
        - 5601:5601
      expose:
        - "5601"
      environment:
        OPENSEARCH_HOSTS: '["https://opensearch-node1:9200"]'

    nginx:
      restart: on-failure:3
      image: nginx:latest
      volumes:
        - ../default-grimoirelab-settings/nginx.conf.template:/etc/nginx/templates/default.conf.template
        - ../default-grimoirelab-settings/uwsgi_params:/etc/nginx/uwsgi_params
        - core-static:/grimoirelab_core:ro
      ports:
        - 8000:8000
      depends_on:
        - grimoirelab_core
      healthcheck:
        test: ["CMD", "curl", "-f", "http://localhost:8000/"]
        interval: 30s
        timeout: 10s
        retries: 5

volumes:
  mariadb_data:
  opensearch_data:
  valkey_data:
  core-static:
